- provide(:title, sub_title="ガンプラ登録")
- breadcrumb :gunpla_up

.row.mx-auto
  .col-lg-8
    .card.shadow-sm
      .card-header
        h2
          = sub_title
      .card-body
        = form_with model: @gunpla, url: create_gunplas_path, local: true do |f|
          .form-group.pb-3
            = f.label :name, class: "form-require"
            = f.text_field :name, autofoucus: true, class: "form-control", placeholder: "例: HGUC 191 RX-78-2ガンダム"
            = render "users/shared/error_messages", errors: @gunpla.errors, error_msg: :name
          .form-group.pb-3
            = f.label :sales_id, class: "form-require"
            div
              =< f.collection_select(:sales_id, Sales.all, :id, :name, { include_blank: "選択して下さい" } )
            = render "users/shared/error_messages", errors: @gunpla.errors, error_msg: :sales_id

          .append_category
            .form-group.pb-3
              = f.label "シリーズ", class: "form-require", for: "gunpla_category_id"
              div
                = f.collection_select :category_id, @category_parent_array, :id, :name, { include_blank: "選択して下さい" }, class: "select_field"
              = render "users/shared/error_messages", errors: @gunpla.errors, error_msg: :category_id

          .text-center.border-top.pb-2
            = f.submit "ガンプラを登録する", class: "btn btn-primary w-250px mt-4"

  = render "sidebar"

javascript:
  $(function(){
    function appendOption(category){
      var html = `<option value="${category.id}">${category.name}</option>`;
      return html;
    }
    function appendChildrenBox(insertHTML) {
      var childSelectHtml = "";
      childSelectHtml = `
                        <div id="children_wrapper" class="form-group pb-3">
                          <label for="child_category" class="form-require">ブランド</label>
                          <div class="category_child">
                            <select id="child_category" name="gunpla[category_id]" class="select_field">
                              <option value="">選択して下さい</option>
                              ${insertHTML}
                            </select>
                          </div>
                        </div>
                        `;
      $('.append_category').append(childSelectHtml);
    }
    function appendGrandchildrenBox(insertHTML){
      var grandchildSelectHtml = "";
      grandchildSelectHtml = `
                            <div id="grandchildren_wrapper" class="form-group pb-3">
                              <label for="grandchild_category" class="form-require">スケール</label>
                              <div class="category_child">
                                <select id="grandchild_category" name="gunpla[category_id]" class="select_field">
                                  <option value="">選択して下さい</option>
                                  ${insertHTML}
                                </select>
                              </div>
                            </div>
                            `;
      $(".append_category").append(grandchildSelectHtml);
    }

    $("#gunpla_category_id").on("change", function(){
      var parentId = document.getElementById("gunpla_category_id").value;
      if (parentId != ""){
        $.ajax({
          url: "/gunplas/get_category_children/",
          type: "GET",
          data: { parent_id: parentId },
          dataType: "json",
        })
        .done(function(children){
          $("#children_wrapper").remove();
          $("#grandchildren_wrapper").remove();
          var insertHTML = "";
          children.forEach(function(child){
            insertHTML += appendOption(child);
          });
          appendChildrenBox(insertHTML);
        })
        .fail(function(){
          alert("データ取得に失敗しました")
        })
      }else{
        $("#children_wrapper").remove();
        $("#grandchildren_wrapper").remove();
      }
    });
    $(".append_category").on("change", "#child_category", function(){
      var childId = document.getElementById("child_category").value;
      if(childId != "" ) {
        $.ajax({
          url: "/gunplas/get_category_grandchildren",
          type: "GET",
          data: { child_id: childId },
          dataType: "json"
        })
        .done(function(grandchildren){
          $("#grandchildren_wrapper").remove();
          var insertHTML = "";
          grandchildren.forEach(function(grandchild){
            insertHTML += appendOption(grandchild);
          });
          appendGrandchildrenBox(insertHTML);
        })
        .fail(function(){
          alert("データ取得に失敗しました");
        })
      }else{
        $("#grandchildren_wrapper").remove();
      }
    })
  });
